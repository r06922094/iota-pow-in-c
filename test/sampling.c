#include "../src/trinary.h"
#include "../src/constants.h"
#include "../src/curl.h"
#include <time.h>
#include <stdio.h>

#ifdef C
#include "../src/pow_c.h"
#define OUT_FILE "pow_c.txt"
#elif SSE
#include "../src/pow_sse.h"
#define OUT_FILE "pow_sse.txt"
#elif CL
#include "../src/pow_cl.h"
#define OUT_FILE "pow_cl.txt"
#endif

static double diff_in_second(struct timespec t1, struct timespec t2)
{
    struct timespec diff;
    if (t2.tv_nsec-t1.tv_nsec < 0) {
        diff.tv_sec  = t2.tv_sec - t1.tv_sec - 1;
        diff.tv_nsec = t2.tv_nsec - t1.tv_nsec + 1000000000;
    } else {
        diff.tv_sec  = t2.tv_sec - t1.tv_sec;
        diff.tv_nsec = t2.tv_nsec - t1.tv_nsec;
    }
    return (diff.tv_sec + diff.tv_nsec / 1000000000.0);
}

int main()
{

    /* test pow */
    Trytes *tx = NULL;
    init_Trytes(&tx);
    char txt[] = "999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999A9RGRKVGWMWMKOLVMDFWJUHNUNYWZTJADGGPZGXNLERLXYWJE9WQHWWBMCPZMVVMJUMWWBLZLNMLDCGDJ999999999999999999999999999999999999999999999999999999YGYQIVD99999999999999999999TXEFLKNPJRBYZPORHZU9CEMFIFVVQBUSTDGSJCZMBTZCDTTJVUFPTCCVHHORPMGCURKTH9VGJIXUQJVHK999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999";
    tx->toTrytes(tx, txt, 2673);

    struct timespec start, end;
    double cpu_time;
    
    clock_gettime(CLOCK_REALTIME, &start);
#ifdef C
    printf("Test pow_c\n");
    Trytes *nonce = PowC(tx, 14);
#elif SSE
    printf("Test  pow_sse\n");
    Trytes *nonce = PowSSE(tx, 14);
#elif AVX
    printf("Test  pow_avx\n");
    Trytes *nonce = PowAVX(tx, 15);
#endif

#ifndef CL
    /* Preparing concatenate two string */
    int rst_len = tx->len - NonceTrinarySize / 3 + nonce->len;
    char *rst = (char *) malloc(rst_len);
    
    for (int i = 0; i < tx->len - NonceTrinarySize / 3; i++) {
        rst[i] = tx->data[i];
    }
    for (int i = 0; i < rst_len - (tx->len - NonceTrinarySize / 3); i++) {
        int idx = tx->len - NonceTrinarySize / 3 + i;
        rst[idx] = nonce->data[i];
    }
    clock_gettime(CLOCK_REALTIME, &end);

    Trytes *last = NULL;
    init_Trytes(&last);
    last->toTrytes(last, rst, rst_len);

    Trytes *last_result = last->Hash(last);
#elif CL
    clock_gettime(CLOCK_REALTIME, &start);
    printf("Test pow_cl\n");
    Trytes *ret = PowCL(tx, 14);
    clock_gettime(CLOCK_REALTIME, &end);
    Trytes *last_result = ret->Hash(ret);
#endif
    FILE *output = fopen(OUT_FILE, "a");
    cpu_time = diff_in_second(start, end);
    fprintf(output, "Elapsed Time %lf sec\n", cpu_time);
    fclose(output);
    
    return 0;

}
